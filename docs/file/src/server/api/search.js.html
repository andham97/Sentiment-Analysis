<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/server/api/search.js | sentiment-analysis</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/andham97/Sentiment-Analysis"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client">client</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components">client/components</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/Button.js~Button.html">Button</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/Card.js~Card.html">Card</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/Checkbox.js~Checkbox.html">Checkbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/DatePickerInterval.js~DatePickerInterval.html">DatePickerInterval</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/ErrorBoundary.js~ErrorBoundary.html">ErrorBoundary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/Filter.js~Filter.html">Filter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/LoadingPage.js~LoadingPage.html">LoadingPage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/TimeInterval.js~TimeInterval.html">TimeInterval</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components-admin">client/components/admin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/admin/AdminPanelStore.js~AdminPanelStore.html">AdminPanelStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/admin/MultiListInput.js~MultiListInput.html">MultiListInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/admin/Scraper.js~Scraper.html">Scraper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AdminPanelContext">AdminPanelContext</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components-dashboard">client/components/dashboard</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/dashboard/Dashboard.js~Dashboard.html">Dashboard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/dashboard/SearchStore.js~SearchStore.html">SearchStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SearchContext">SearchContext</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components-result">client/components/result</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/NewsArticle.js~NewsArticle.html">NewsArticle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/NewsArticleSentiment.js~NewsArticle.html">NewsArticle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/NoResult.js~NoResult.html">NoResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/Parameters.js~Paramteres.html">Paramteres</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/Result.js~Result.html">Result</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/ResultSentiment.js~ResultSentiment.html">ResultSentiment</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components-result-graph">client/components/result/graph</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/graph/DonutChart.js~DonutChart.html">DonutChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ProgressBar">ProgressBar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server">server</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connectCloudant">connectCloudant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCloudant">getCloudant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-start">start</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-newsapi">newsapi</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nlu">nlu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-server">server</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-routes">server/routes</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isWhitelisted">isWhitelisted</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-ws">server/ws</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-index">index</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nlu">nlu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadIndex">loadIndex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ws">ws</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server/api/search.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import stt from &apos;search-text-tokenizer&apos;;
import { getCloudant } from &apos;../ics&apos;;

const search = (query, options) =&gt; new Promise((resolve, reject) =&gt; {
  if (!getCloudant())
    return reject();
  query = query.replace(/[^a-zA-Z\s-]/g, &apos;&apos;);
  if (query === &apos;&apos;)
    return reject({ code: 400, err: new Error(&apos;Error: Empty query not supported&apos;) });
  const tokens = stt(query);
  const includes = tokens.filter(token =&gt; !token.exclude).map(token =&gt; token.term);
  const excludes = tokens.filter(token =&gt; token.exclude).map(token =&gt; token.term);
  const regex = includes.reduce((acc, val, i) =&gt; `${i === 0 ? &apos;(&apos; : &apos;&apos;}${acc + val}${i === includes.length - 1 ? &apos;)&apos; : &apos;|&apos;}`, &apos;&apos;);
  const negRegex = excludes.reduce((acc, val, i) =&gt; `${i === 0 ? &apos;(&apos; : &apos;&apos;}${acc + val}${i === excludes.length - 1 ? &apos;)&apos; : &apos;|&apos;}`, &apos;&apos;);
  let sources = &apos;&apos;;
  let sourceRegex = &apos;&apos;;
  if (options &amp;&amp; options.sources &amp;&amp; typeof options.sources === &apos;string&apos;) {
    sources = options.sources;
    sources = sources.split(&apos;,&apos;).join(&apos; &apos;);
  }
  else if (options &amp;&amp; options.sources &amp;&amp; options.sources.join)
    sources = options.sources.join(&apos; &apos;);
  if (sources === &apos;&apos;)
    sourceRegex = &apos;.+&apos;;
  else {
    const sTokens = stt(sources);
    const sourceList = sTokens.filter(token =&gt; !token.exclude).map(token =&gt; token.term.replace(/[^a-zA-Z-]/g, &apos;&apos;));
    sourceRegex = sourceList.reduce((acc, val, i) =&gt; `${i === 0 ? &apos;(&apos; : &apos;&apos;}${acc + val}${i === sourceList.length - 1 ? &apos;)&apos; : &apos;|&apos;}`, &apos;&apos;);
  }
  try {
    RegExp(sourceRegex);
    RegExp(regex);
    RegExp(negRegex);
  }
  catch (e) {
    return reject({ code: 400, err: new Error(&apos;Error: Invalid query parameters&apos;) });
  }
  const opts = {
    selector: {
      $and: [
        {
          &apos;analysis.text&apos;: {
            $regex: `(?i)${regex}`,
          },
        },
        {
          sourceID: {
            $regex: `(?i)${sourceRegex}`,
          },
        },
      ],
    },
    fields: [
      &apos;_id&apos;,
      &apos;_rev&apos;,
      &apos;date&apos;,
      &apos;headline&apos;,
      &apos;analysis&apos;,
      &apos;url&apos;,
      &apos;sourceID&apos;,
    ],
    sort: [
      {
        date: &apos;desc&apos;,
      },
    ],
    limit: 10000,
  };
  if (options.bookmark)
    opts.bookmark = options.bookmark;
  if (options.intervalStart)
    opts.selector.$and.push({
      date: {
        $gte: Number(options.intervalStart),
      },
    });
  if (options.intervalEnd)
    opts.selector.$and.push({
      date: {
        $lte: Number(options.intervalEnd),
      },
    });
  if (negRegex !== &apos;&apos;)
    opts.selector.$and.push({
      $not: {
        &apos;analysis.text&apos;: {
          $regex: `(?i)${negRegex}`,
        },
      },
    });
  const find = () =&gt; {
    getCloudant().db.use(&apos;sa-index&apos;).find(opts).then((data) =&gt; {
      data.docs = data.docs.map((doc) =&gt; {
        if (doc.date &lt; 0) {
          doc.date = new Date().getTime();
          getCloudant().db.use(&apos;sa-index&apos;).insert(doc, (err) =&gt; {
            if (err)
              console.error(err);
          });
        }
        delete doc._rev;
        return doc;
      });
      resolve({ ...data, params: includes });
    }).catch((err) =&gt; {
      console.error(err);
      if (err.statusCode === 401 || err.reason.indexOf(&apos;_design&apos;) || err.reason.indexOf(&apos;_reader&apos;))
        find();
      else
        reject(err);
    });
  };
  find();
});

const getSources = () =&gt; new Promise((resolve, reject) =&gt; {
  if (!getCloudant())
    return reject();
  const find = () =&gt; {
    getCloudant().db.use(&apos;sa-index&apos;).view(&apos;searches&apos;, &apos;source-view&apos;, {
      group: true,
    }).then((data) =&gt; {
      const find2 = () =&gt; {
        getCloudant().db.use(&apos;sa-meta&apos;).find({ selector: { type: &apos;ws&apos; } }).then(({ docs }) =&gt; {
          const hosts = Object.keys(docs[0]).filter(key =&gt; docs[0][key].sourceID);
          const keys = data.rows.map(e =&gt; e.key);
          resolve(keys.map(key =&gt; ({
            key,
            value: docs[0][hosts.filter(k =&gt; docs[0][k].sourceID === key)[0]].name,
          })));
        }).catch((err) =&gt; {
          if (!err.reason)
            return reject(err);
          if (err.statusCode === 401 || err.reason.indexOf(&apos;_design&apos;) || err.reason.indexOf(&apos;_reader&apos;))
            find2();
          else
            reject(err);
        });
      };
      find2();
    }).catch((err) =&gt; {
      if (err.statusCode === 401 || err.reason.indexOf(&apos;_design&apos;) || err.reason.indexOf(&apos;_reader&apos;))
        find();
      else
        reject(err);
    });
  };
  find();
});

export default { search, getSources };
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
