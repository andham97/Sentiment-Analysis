<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">src/client/components/dashboard/SearchStore.js | sentiment-analysis</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/andham97/Sentiment-Analysis"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client">client</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components">client/components</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/Button.js~Button.html">Button</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/Card.js~Card.html">Card</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/Checkbox.js~Checkbox.html">Checkbox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/DatePickerInterval.js~DatePickerInterval.html">DatePickerInterval</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/ErrorBoundary.js~ErrorBoundary.html">ErrorBoundary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/Filter.js~Filter.html">Filter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/LoadingPage.js~LoadingPage.html">LoadingPage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/TimeInterval.js~TimeInterval.html">TimeInterval</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components-admin">client/components/admin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/admin/AdminPanelStore.js~AdminPanelStore.html">AdminPanelStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/admin/MultiListInput.js~MultiListInput.html">MultiListInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/admin/Scraper.js~Scraper.html">Scraper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AdminPanelContext">AdminPanelContext</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components-dashboard">client/components/dashboard</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/dashboard/Dashboard.js~Dashboard.html">Dashboard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/dashboard/SearchStore.js~SearchStore.html">SearchStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SearchContext">SearchContext</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components-result">client/components/result</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/NewsArticle.js~NewsArticle.html">NewsArticle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/NewsArticleSentiment.js~NewsArticle.html">NewsArticle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/NoResult.js~NoResult.html">NoResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/Parameters.js~Paramteres.html">Paramteres</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/Result.js~Result.html">Result</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/ResultSentiment.js~ResultSentiment.html">ResultSentiment</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-components-result-graph">client/components/result/graph</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/components/result/graph/DonutChart.js~DonutChart.html">DonutChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ProgressBar">ProgressBar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server">server</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connectCloudant">connectCloudant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCloudant">getCloudant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-start">start</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-newsapi">newsapi</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nlu">nlu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-server">server</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-routes">server/routes</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isWhitelisted">isWhitelisted</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-ws">server/ws</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-index">index</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nlu">nlu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadIndex">loadIndex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ws">ws</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/client/components/dashboard/SearchStore.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import React from &apos;react&apos;;
import PropTypes from &apos;prop-types&apos;;

const SearchContext = React.createContext();

class SearchStore extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      words: [],
      searchType: &apos;&apos;,
      sources: [],
    };
    this.getSearch = this.getSearch.bind(this);
    this.getWords = this.getWords.bind(this);
    this.getSources = this.getSources.bind(this);
    this.getEmotionalTone = this.getEmotionalTone.bind(this);
    this.getEmotionalToneSentiment = this.getEmotionalToneSentiment.bind(this);
    this.computeSearch = this.computeSearch.bind(this);
  }

  getSearch(opts) {
    if (opts.startDate &amp;&amp; opts.startDate.getTime)
      opts.startDate = opts.startDate.getTime();
    if (opts.endDate &amp;&amp; opts.endDate.getTime)
      opts.endDate = opts.endDate.getTime();
    localStorage.setItem(&apos;prev-search&apos;, JSON.stringify(opts));
    if (!opts.startDate)
      opts.startDate = 0;
    if (!opts.endDate)
      opts.endDate = new Date().getTime();
    this.setState({
      ...this.state, search: undefined, searchOpts: opts, searchType: opts.show ? &apos;emotion&apos; : &apos;sentiment&apos;,
    });
    const sources = opts.checkedItemsNews.join(&apos;,&apos;);
    fetch(`/api/search?q=${opts.search}${sources.length &gt; 0 ? `&amp;sources=${sources}` : &apos;&apos;}${opts.startDate ? `&amp;intervalStart=${opts.startDate}` : &apos;&apos;}${opts.endDate ? `&amp;intervalEnd=${opts.endDate}` : &apos;&apos;}`, {
      method: &apos;GET&apos;,
      headers: {
        &apos;Content-Type&apos;: &apos;application/json&apos;,
      },
    }).then(response =&gt; response.json()).then((data) =&gt; {
      this.computeSearch(data, opts);
    }).catch(console.error);
  }

  computeSearch(data, opts) {
    const search = JSON.parse(JSON.stringify(data));
    search.docs = search.docs
      .filter(doc =&gt; (opts.startDate ? doc.date &gt;= opts.startDate : true)
          &amp;&amp; (opts.endDate ? doc.date &lt;= opts.endDate : true));
    if (search.docs.length === 0) {
      this.setState({
        ...this.state,
        search: data,
        searchOpts: opts,
        searchType: opts.show ? &apos;emotion&apos; : &apos;sentiment&apos;,
      });
    }
    else if (!opts.show) {
      const colors = [&apos;#5EA3DB&apos;, &apos;#FF5C54&apos;, &apos;#AFBE8F&apos;];
      const average = search.docs.reduce((acc, val) =&gt; {
        let sentiment = val.analysis.sentiment;
        if (!sentiment) {
          sentiment = {
            score: 0,
            label: &apos;neutral&apos;,
          };
        }
        let label = &apos;neutral&apos;;
        if (sentiment.score &gt; opts.neutralThreshold)
          label = &apos;positive&apos;;
        else if (sentiment.score &lt; -opts.neutralThreshold)
          label = &apos;negative&apos;;
        acc.sentiment[label]++;
        return acc;
      }, {
        sentiment: { positive: 0, negative: 0, neutral: 0 },
      });

      Object.keys(average).forEach((key) =&gt; {
        if (typeof average[key] === &apos;number&apos;)
          average[key] /= search.docs.length;
        else
          Object.keys(average[key]).forEach((key2) =&gt; {
            average[key][key2] /= search.docs.length;
          });
      });
      this.setState({
        ...this.state,
        graphData: Object.keys(average.sentiment ? average.sentiment : {}).map(
          (key, i) =&gt; (
            {
              title: key,
              value: Math.floor(average.sentiment[key] * 100),
              color: colors[i],
            }),
        ),
        search: data,
        emotionalTone: this.getEmotionalToneSentiment(search, opts),
        searchOpts: opts,
        searchType: opts.show ? &apos;emotion&apos; : &apos;sentiment&apos;,
      });
    }
    else if (opts.show) {
      const colors = [&apos;#D3C0CD&apos;, &apos;#9FAF90&apos;, &apos;#3A405A&apos;, &apos;#3D70B2&apos;, &apos;#E26D5A&apos;];
      const average = search.docs.reduce((acc, val) =&gt; {
        let emotion = val.analysis.emotion;
        if (!emotion) {
          emotion = {
            anger: 0,
            joy: 0,
            disgust: 0,
            fear: 0,
            sadness: 0,
          };
        }
        Object.keys(emotion).forEach((k) =&gt; {
          acc[k] += emotion[k];
        });
        acc.sentiment[val.analysis.sentiment.label]++;
        return acc;
      }, {
        sentiment: { positive: 0, negative: 0, neutral: 0 },
        joy: 0,
        disgust: 0,
        fear: 0,
        sadness: 0,
        anger: 0,
      });

      Object.keys(average).forEach((key) =&gt; {
        if (typeof average[key] === &apos;number&apos;)
          average[key] /= search.docs.length;
        else
          Object.keys(average[key]).forEach((key2) =&gt; {
            average[key][key2] /= search.docs.length;
          });
      });
      this.setState({
        ...this.state,
        graphData: Object.keys(average).filter(e =&gt; e !== &apos;sentiment&apos;).map(
          (key, i) =&gt; ({ title: key, value: Math.floor(average[key] * 100), color: colors[i] }),
        ),
        search: data,
        emotionalTone: this.getEmotionalTone(search),
        searchOpts: opts,
        searchType: opts.show ? &apos;emotion&apos; : &apos;sentiment&apos;,
      });
    }
  }

  getSources() {
    fetch(&apos;/api/search/sources&apos;).then(res =&gt; res.json()).then((data) =&gt; {
      this.setState({
        ...this.state,
        sources: data,
      });
    });
  }

  getWords(count) {
    if (!count)
      count = 30;
    fetch(`/api/wordcloud?length=${count}`).then(res =&gt; res.json()).then((data) =&gt; {
      this.setState({
        ...this.state,
        words: data.map(elem =&gt; ({
          value: elem.key,
          count: elem.value,
        })),
      });
    });
  }

  getEmotionalTone(search) {
    const sortArr = search.docs.sort(
      (a, b) =&gt; a.date - b.date,
    ).filter(a =&gt; a.date &gt; 0).map((element) =&gt; {
      const date = new Date(element.date);
      date.setHours(12);
      date.setMinutes(0);
      date.setSeconds(0);
      date.setMilliseconds(0);
      element.date = date.getTime();
      return element;
    });
    const days = {};
    sortArr.forEach((element) =&gt; {
      if (days[element.date])
        days[element.date].push(element);
      else
        days[element.date] = [element];
    });
    const ret = [];
    Object.keys(days).forEach((key, i) =&gt; {
      const emotions = days[key].reduce((acc, val) =&gt; {
        const emotion = val.analysis.emotion;
        if (!emotion)
          return acc;
        Object.keys(acc).forEach((k) =&gt; {
          acc[k].perc += emotion[k];
        });
        return acc;
      }, {
        anger: { perc: 0 },
        joy: { perc: 0 },
        disgust: { perc: 0 },
        fear: { perc: 0 },
        sadness: { perc: 0 },
      });
      Object.keys(emotions).forEach((k) =&gt; {
        emotions[k].perc /= days[key].length;
        emotions[k].perc *= 1000;
        emotions[k].perc = Math.round(emotions[k].perc);
        emotions[k].perc /= 10;
      });
      ret.push({
        id: i,
        date: new Date(Number(key)).toLocaleDateString(),
        emotions,
        time: new Date(Number(key)).getTime(),
      });
    });
    return ret;
  }

  getEmotionalToneSentiment(search, opts) {
    const sortArr = search.docs.sort(
      (a, b) =&gt; a.date - b.date,
    ).filter(a =&gt; a.date &gt; 0).map((element) =&gt; {
      const date = new Date(element.date);
      date.setHours(12);
      date.setMinutes(0);
      date.setSeconds(0);
      date.setMilliseconds(0);
      element.date = date.getTime();
      return element;
    });
    const days = {};
    sortArr.forEach((element) =&gt; {
      if (days[element.date])
        days[element.date].push(element);
      else
        days[element.date] = [element];
    });
    const ret = Object.keys(days).map((key) =&gt; {
      const sentiments = days[key].reduce((acc, val) =&gt; {
        const sentiment = val.analysis.sentiment;
        if (!sentiment)
          return acc;
        if (sentiment.score &gt; opts.neutralThreshold)
          acc.positive.score++;
        if (sentiment.score &gt; -opts.neutralThreshold)
          acc.neutral.score++;
        else
          acc.negative.score++;
        return acc;
      }, {
        negative: { score: 0 },
        neutral: { score: 0 },
        positive: { score: 0 },
      });
      return { sentiments, key };
    });
    return ret.map((val, i) =&gt; ({
      id: i,
      date: new Date(Number(val.key)).toLocaleDateString(),
      sentiments: val.sentiments,
      time: new Date(Number(val.key)).getTime(),
    }));
  }

  render() {
    return (
      &lt;SearchContext.Provider value={{
        ...this.state,
        getSearch: this.getSearch,
        getWords: this.getWords,
        getSources: this.getSources,
        getEmotionalTone: this.getEmotionalTone,
        getEmotionalToneSentiment: this.getEmotionalToneSentiment,
        computeSearch: this.computeSearch,
      }}&gt;
      {this.props.children}
      &lt;/SearchContext.Provider&gt;
    );
  }
}

SearchStore.propTypes = {
  children: PropTypes.any,
};

export default SearchStore;

export { SearchContext };
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
